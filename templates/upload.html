<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadIMO Admin - Medweb CSV Upload</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f0f0;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: #004892;
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.8rem;
    }

    .header-actions a {
      color: white;
      text-decoration: none;
      margin-left: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      transition: background 0.2s;
    }

    .header-actions a:hover {
      background: rgba(255,255,255,0.3);
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .card h2 {
      margin-bottom: 1rem;
      color: #333;
      border-bottom: 2px solid #004892;
      padding-bottom: 0.5rem;
    }

    .upload-section {
      background: #f8f9fa;
      padding: 2rem;
      border-radius: 8px;
      border: 2px dashed #004892;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .form-group input[type="file"],
    .form-group input[type="date"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    .btn-primary {
      background: #004892;
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 4px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #003670;
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .message {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .stats-table th,
    .stats-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .stats-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .stats-table tr:hover {
      background: #f8f9fa;
    }

    .skill-column {
      text-align: center;
    }

    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .info-box h3 {
      margin-bottom: 0.5rem;
      color: #856404;
    }

    .operational-checks {
      list-style: none;
    }

    .operational-checks li {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }

    .check-ok {
      background: #d4edda;
      color: #155724;
    }

    .check-warning {
      background: #fff3cd;
      color: #856404;
    }

    .check-error {
      background: #f8d7da;
      color: #721c24;
    }

    .debug-section {
      margin-top: 2rem;
    }

    .debug-section summary {
      cursor: pointer;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 4px;
      font-weight: 600;
      user-select: none;
    }

    .debug-section summary:hover {
      background: #e9ecef;
    }

    .debug-content {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 4px;
      overflow-x: auto;
    }

    .config-info {
      background: #e7f3ff;
      border-left: 4px solid #004892;
      padding: 1rem;
      margin-bottom: 2rem;
    }

    .config-info code {
      background: #fff;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üè• RadIMO Admin Panel</h1>
      <p>Medweb CSV Upload & System Verwaltung</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('skill_roster_page') }}">üìã Skill Roster (Planning)</a>
      <a href="{{ url_for('prep_next_day') }}">üìù N√§chsten Tag Bearbeiten</a>
      <a href="{{ url_for('live_edit_page') }}">‚ö†Ô∏è Live Edit</a>
      <a href="{{ url_for('index', modality=modality) }}">‚Üê Zur√ºck zur Zuteilung</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <div id="message-container"></div>

  <!-- Upload Section -->
  <div class="card">
    <h2>üì§ Medweb CSV Upload</h2>

    <div class="config-info">
      <strong>‚ÑπÔ∏è Config-gesteuerte Medweb-Anbindung</strong>
      <p>Diese Seite verwendet die <code>medweb_mapping</code> Regeln aus <code>config.yaml</code> um CSV-Aktivit√§ten automatisch auf Modalit√§ten und Skills zu mappen.</p>
      <p><strong>Unterst√ºtzte Aktivit√§ten:</strong> CT Assistent, CT Sp√§tdienst, MR Assistent, MR Assistent 1. Monat, MRT Sp√§tdienst, Chir Assistent, OA/FA Chir, SBZ: MRT-OA, etc.</p>
    </div>

    <div class="upload-section">
      <form id="upload-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="csv-file">üìÅ Medweb CSV Datei:</label>
          <input type="file" id="csv-file" name="file" accept=".csv" required>
          <small style="color: #666; display: block; margin-top: 0.5rem;">
            Erwartet: medweb CSV mit Spalten wie "Datum", "Beschreibung der Aktivit√§t", "Name des Mitarbeiters", "Code des Mitarbeiters"
          </small>
        </div>

        <div class="form-group">
          <label for="target-date">üìÖ Zieldatum:</label>
          <input type="date" id="target-date" name="target_date" required>
          <small style="color: #666; display: block; margin-top: 0.5rem;">
            Das Datum f√ºr welches die Dienstpl√§ne aus der CSV extrahiert werden sollen
          </small>
        </div>

        <button type="submit" class="btn-primary" id="upload-btn">
          ‚¨ÜÔ∏è CSV Hochladen & Verarbeiten
        </button>
      </form>
    </div>
  </div>

  <!-- Preload Next Workday Section -->
  <div class="card">
    <h2>üîÆ Preload N√§chster Arbeitstag</h2>

    <div class="info-box">
      <h3>‚ÑπÔ∏è Automatisches Preload</h3>
      <p>L√§dt automatisch den <strong>n√§chsten Arbeitstag</strong> aus der medweb CSV:</p>
      <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li>Freitag ‚Üí l√§dt <strong>Montag</strong></li>
        <li>Andere Tage ‚Üí l√§dt <strong>Morgen</strong></li>
        <li>√úberspringt Wochenenden automatisch</li>
      </ul>
    </div>

    <div class="upload-section">
      <form id="preload-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="preload-csv-file">üìÅ Medweb CSV Datei (mit ~1 Monat Eintr√§gen):</label>
          <input type="file" id="preload-csv-file" name="file" accept=".csv" required>
          <small style="color: #666; display: block; margin-top: 0.5rem;">
            Die CSV sollte Eintr√§ge f√ºr mehrere Tage enthalten. Das System w√§hlt automatisch den n√§chsten Arbeitstag.
          </small>
        </div>

        <button type="submit" class="btn-primary" id="preload-btn" style="background: #28a745;">
          üîÆ N√§chsten Arbeitstag Preloaden
        </button>
        <div id="preload-info" style="margin-top: 1rem; padding: 0.75rem; background: #e7f3ff; border-radius: 4px; display: none;">
          <strong>N√§chster Arbeitstag:</strong> <span id="next-workday"></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Force Refresh Today Section -->
  <div class="card">
    <h2>üîÑ Force Refresh (Heute - NOTFALL)</h2>

    <div class="info-box" style="background: #fff3cd; border-color: #f39c12;">
      <h3>‚ö†Ô∏è Warnung: Alle Zuteilungen werden gel√∂scht!</h3>
      <p>Diese Funktion √ºberschreibt den <strong>heutigen</strong> Dienstplan komplett:</p>
      <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li style="color: #856404;"><strong>Alle bisherigen Zuteilungen werden gel√∂scht</strong></li>
        <li style="color: #856404;"><strong>Alle Z√§hlerst√§nde werden zur√ºckgesetzt</strong></li>
        <li>Nur f√ºr Notfall-√Ñnderungen verwenden!</li>
        <li>Besser: N√§chsten Tag mit Preload vorbereiten</li>
      </ul>
    </div>

    <div class="upload-section" style="border-color: #f39c12;">
      <form id="force-refresh-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="force-refresh-csv-file">üìÅ Neue Medweb CSV Datei:</label>
          <input type="file" id="force-refresh-csv-file" name="file" accept=".csv" required>
          <small style="color: #666; display: block; margin-top: 0.5rem;">
            L√§dt Daten f√ºr <strong>HEUTE</strong> und l√∂scht alle bisherigen Zuteilungen!
          </small>
        </div>

        <button type="submit" class="btn-primary" id="force-refresh-btn" style="background: #f39c12;" onclick="return confirm('WARNUNG: Alle heutigen Zuteilungen werden gel√∂scht! Fortfahren?');">
          üîÑ HEUTE Neu Laden (Notfall)
        </button>
      </form>
    </div>
  </div>

  <!-- Operational Checks -->
  {% if operational_checks %}
  <div class="card">
    <h2>‚úÖ System-Checks</h2>
    <ul class="operational-checks">
      {% for check in operational_checks.results %}
        <li class="{% if check.status == 'OK' %}check-ok{% elif check.status == 'WARNING' %}check-warning{% else %}check-error{% endif %}">
          <strong>{{ check.name }}:</strong> {{ check.status }}
          {% if check.detail %}
            <br><small>{{ check.detail }}</small>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    <p style="margin-top: 1rem; color: #666;"><small>Letzte Pr√ºfung: {{ operational_checks.timestamp }}</small></p>
  </div>
  {% endif %}

  <!-- Worker Statistics -->
  {% if combined_workers %}
  <div class="card">
    <h2>üìä Worker Statistiken (Alle Modalit√§ten)</h2>
    <div style="overflow-x: auto;">
      <table class="stats-table">
        <thead>
          <tr>
            <th>Worker</th>
            {% for skill in skill_counts.keys() %}
              <th class="skill-column">{{ skill }}</th>
            {% endfor %}
            <th class="skill-column"><strong>Total</strong></th>
            <th class="skill-column">Global</th>
            <th class="skill-column">Weighted</th>
          </tr>
        </thead>
        <tbody>
          {% for worker in combined_workers %}
            <tr>
              <td><strong>{{ worker }}</strong></td>
              {% for skill in skill_counts.keys() %}
                <td class="skill-column">{{ modality_stats[worker][skill] }}</td>
              {% endfor %}
              <td class="skill-column"><strong>{{ modality_stats[worker].total }}</strong></td>
              <td class="skill-column">{{ global_counts.get(worker, 0) }}</td>
              <td class="skill-column">{{ "%.2f"|format(global_weighted_counts.get(worker, 0)) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p style="margin-top: 1rem; color: #666;">
      <small>
        <strong>Total:</strong> Zuteilungen in dieser Modalit√§t |
        <strong>Global:</strong> Zuteilungen √ºber alle Modalit√§ten |
        <strong>Weighted:</strong> Gewichtete Zuteilungen (ber√ºcksichtigt Skill-Faktoren)
      </small>
    </p>
  </div>
  {% endif %}

  <!-- Debug Info -->
  <details class="card debug-section">
    <summary>üîç Debug-Informationen (working_hours_df)</summary>
    <div class="debug-content">
      {{ debug_info|safe }}
    </div>
  </details>

  <script>
    // Helper: Calculate next workday
    function getNextWorkday() {
      const today = new Date();
      let nextDay = new Date(today);
      nextDay.setDate(nextDay.getDate() + 1);

      // Skip weekends
      while (nextDay.getDay() === 0 || nextDay.getDay() === 6) {
        nextDay.setDate(nextDay.getDate() + 1);
      }

      return nextDay;
    }

    // Helper: Format date as YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Helper: Format date for display (German format)
    function formatDateGerman(date) {
      const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const weekday = weekdays[date.getDay()];
      return `${weekday}, ${day}.${month}.${year}`;
    }

    // Set today as default date
    document.getElementById('target-date').valueAsDate = new Date();

    // Show next workday info
    const nextWorkday = getNextWorkday();
    document.getElementById('next-workday').textContent = formatDateGerman(nextWorkday);
    document.getElementById('preload-info').style.display = 'block';

    // Handle upload form submission
    document.getElementById('upload-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const uploadBtn = document.getElementById('upload-btn');
      const messageContainer = document.getElementById('message-container');

      // Disable button
      uploadBtn.disabled = true;
      uploadBtn.textContent = '‚è≥ Verarbeite...';

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Success
          messageContainer.innerHTML = `
            <div class="message success">
              ‚úÖ ${result.message}<br>
              <strong>Modalit√§ten geladen:</strong> ${result.modalities_loaded.join(', ')}<br>
              <strong>Workers gefunden:</strong> ${result.total_workers}
            </div>
          `;

          // Reload page after 2 seconds to show updated stats
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          // Error
          messageContainer.innerHTML = `
            <div class="message error">
              ‚ùå Fehler: ${result.error || 'Unbekannter Fehler'}
            </div>
          `;
          uploadBtn.disabled = false;
          uploadBtn.textContent = '‚¨ÜÔ∏è CSV Hochladen & Verarbeiten';
        }
      } catch (error) {
        messageContainer.innerHTML = `
          <div class="message error">
            ‚ùå Netzwerkfehler: ${error.message}
          </div>
        `;
        uploadBtn.disabled = false;
        uploadBtn.textContent = '‚¨ÜÔ∏è CSV Hochladen & Verarbeiten';
      }
    });

    // Handle preload form submission
    document.getElementById('preload-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const preloadBtn = document.getElementById('preload-btn');
      const messageContainer = document.getElementById('message-container');

      // Disable button
      preloadBtn.disabled = true;
      preloadBtn.textContent = '‚è≥ Preloade...';

      try {
        const response = await fetch('/preload-next-day', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Success
          messageContainer.innerHTML = `
            <div class="message success">
              ‚úÖ ${result.message}<br>
              <strong>Datum:</strong> ${result.target_date}<br>
              <strong>Modalit√§ten geladen:</strong> ${result.modalities_loaded.join(', ')}<br>
              <strong>Workers gefunden:</strong> ${result.total_workers}
            </div>
          `;

          // Scroll to message
          messageContainer.scrollIntoView({ behavior: 'smooth' });

          // Reload page after 2 seconds to show updated stats
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          // Error
          messageContainer.innerHTML = `
            <div class="message error">
              ‚ùå Fehler: ${result.error || result.message || 'Unbekannter Fehler'}
            </div>
          `;
          messageContainer.scrollIntoView({ behavior: 'smooth' });
          preloadBtn.disabled = false;
          preloadBtn.textContent = 'üîÆ N√§chsten Arbeitstag Preloaden';
        }
      } catch (error) {
        messageContainer.innerHTML = `
          <div class="message error">
            ‚ùå Netzwerkfehler: ${error.message}
          </div>
        `;
        messageContainer.scrollIntoView({ behavior: 'smooth' });
        preloadBtn.disabled = false;
        preloadBtn.textContent = 'üîÆ N√§chsten Arbeitstag Preloaden';
      }
    });

    // Handle force refresh form submission
    document.getElementById('force-refresh-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const forceBtn = document.getElementById('force-refresh-btn');
      const messageContainer = document.getElementById('message-container');

      // Disable button
      forceBtn.disabled = true;
      forceBtn.textContent = '‚è≥ Force Refresh l√§uft...';

      try {
        const response = await fetch('/force-refresh-today', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Success
          messageContainer.innerHTML = `
            <div class="message success">
              ‚úÖ ${result.message}<br>
              <strong>Modalit√§ten geladen:</strong> ${result.modalities_loaded.join(', ')}<br>
              <strong>Workers gefunden:</strong> ${result.total_workers}<br>
              <strong style="color: #f39c12;">‚ö†Ô∏è ${result.warning}</strong>
            </div>
          `;

          // Scroll to message
          messageContainer.scrollIntoView({ behavior: 'smooth' });

          // Reload page after 2 seconds to show updated stats
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          // Error
          messageContainer.innerHTML = `
            <div class="message error">
              ‚ùå Fehler: ${result.error || result.message || 'Unbekannter Fehler'}
            </div>
          `;
          messageContainer.scrollIntoView({ behavior: 'smooth' });
          forceBtn.disabled = false;
          forceBtn.textContent = 'üîÑ HEUTE Neu Laden (Notfall)';
        }
      } catch (error) {
        messageContainer.innerHTML = `
          <div class="message error">
            ‚ùå Netzwerkfehler: ${error.message}
          </div>
        `;
        messageContainer.scrollIntoView({ behavior: 'smooth' });
        forceBtn.disabled = false;
        forceBtn.textContent = 'üîÑ HEUTE Neu Laden (Notfall)';
      }
    });
  </script>
</body>
</html>
