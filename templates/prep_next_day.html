<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>N√§chsten Tag Vorbereiten - RadIMO</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f0f0;
      padding: 1rem;
    }

    .header {
      background: #004892;
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.8rem;
    }

    .header-actions a, .header-actions button {
      color: white;
      text-decoration: none;
      margin-left: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 1rem;
    }

    .header-actions a:hover, .header-actions button:hover {
      background: rgba(255,255,255,0.3);
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #004892;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 4px;
    }

    .mode-toggle {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .mode-toggle button {
      padding: 0.75rem 1.5rem;
      border: 2px solid #004892;
      background: white;
      color: #004892;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .mode-toggle button.active {
      background: #004892;
      color: white;
    }

    .modality-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #ddd;
    }

    .modality-tabs button {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .modality-tabs button.active {
      border-bottom-color: #004892;
      color: #004892;
    }

    .edit-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .edit-table th, .edit-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .edit-table th {
      background: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .edit-table td[contenteditable="true"] {
      background: #fffbf0;
      cursor: text;
      position: relative;
    }

    .edit-table td[contenteditable="true"]:hover {
      background: #fff4cc;
    }

    .edit-table td[contenteditable="true"]:focus {
      outline: 2px solid #004892;
      background: white;
    }

    .edit-table tr:hover {
      background: #f8f9fa;
    }

    .edit-table td.skill-cell {
      text-align: center;
      font-weight: 600;
    }

    .skill-1 { color: #28a745; }
    .skill-0 { color: #ffc107; }
    .skill--1 { color: #dc3545; }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #004892;
      color: white;
    }

    .btn-primary:hover {
      background: #003670;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
    }

    .message {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .advanced-tools {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .advanced-tools.visible {
      display: block;
    }

    .table-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .bulk-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üìù N√§chsten Tag Vorbereiten</h1>
      <p>Datum: <strong>{{ target_date_german }}</strong> ({{ target_date }})</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('upload_file') }}">Admin Panel</a>
      <a href="{{ url_for('skill_roster_page') }}">üìã Skill Roster</a>
      <a href="{{ url_for('live_edit_page') }}">‚ö†Ô∏è Live Edit</a>
      <a href="{{ url_for('index', modality='ct') }}">Zur Zuteilung</a>
    </div>
  </div>

  <div id="message-container"></div>

  <div class="card">
    <div class="info-box">
      <strong>‚ÑπÔ∏è N√§chsten Tag bearbeiten</strong>
      <p>Hier k√∂nnen Sie den Dienstplan f√ºr morgen anpassen. <strong>Keine Zuteilungen vorhanden</strong> - Sie arbeiten mit einem sauberen Zustand.</p>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <button id="mode-simple" class="active" onclick="setMode('simple')">
        ‚úèÔ∏è Einfach (Zellen Editieren)
      </button>
      <button id="mode-advanced" onclick="setMode('advanced')">
        üîß Erweitert (Hinzuf√ºgen/L√∂schen)
      </button>
    </div>

    <!-- Modality Tabs -->
    <div class="modality-tabs">
      <button class="active" onclick="switchModality('ct')">CT</button>
      <button onclick="switchModality('mr')">MR</button>
      <button onclick="switchModality('xray')">XRAY</button>
    </div>

    <!-- Edit Table -->
    <div class="table-container">
      <table class="edit-table" id="edit-table">
        <thead>
          <tr>
            <th>Worker</th>
            <th>Von</th>
            <th>Bis</th>
            <th>Normal</th>
            <th>Notfall</th>
            <th>Privat</th>
            <th>Herz</th>
            <th>Msk</th>
            <th>Chest</th>
            <th>Modifier</th>
            <th id="actions-header" style="display:none;">Aktionen</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- Rows loaded dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Advanced Tools -->
    <div id="advanced-tools" class="advanced-tools">
      <h3>Erweiterte Funktionen</h3>
      <div class="bulk-actions">
        <button class="btn btn-success" onclick="addWorkerRow()">
          ‚ûï Worker Hinzuf√ºgen
        </button>
        <button class="btn btn-primary" onclick="bulkSetSkill()">
          üîÑ Bulk Skill Setzen
        </button>
      </div>
    </div>

    <!-- Save Button -->
    <div style="margin-top: 2rem;">
      <button class="btn btn-success" onclick="saveAllChanges()" style="font-size: 1.1rem; padding: 1rem 2rem;">
        üíæ Alle √Ñnderungen Speichern
      </button>
      <span id="save-status" style="margin-left: 1rem; color: #666;"></span>
    </div>
  </div>

  <script>
    let currentModality = 'ct';
    let currentMode = 'simple';
    let tableData = {};
    let pendingChanges = {};

    // Load data on page load
    async function loadData() {
      try {
        const response = await fetch('/api/prep-next-day/data');
        const data = await response.json();
        tableData = data;
        renderTable();
      } catch (error) {
        showMessage('error', `Fehler beim Laden: ${error.message}`);
      }
    }

    // Set editing mode
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('mode-simple').classList.toggle('active', mode === 'simple');
      document.getElementById('mode-advanced').classList.toggle('active', mode === 'advanced');
      document.getElementById('advanced-tools').classList.toggle('visible', mode === 'advanced');
      document.getElementById('actions-header').style.display = mode === 'advanced' ? '' : 'none';
      renderTable();
    }

    // Switch modality
    function switchModality(modality) {
      currentModality = modality;
      document.querySelectorAll('.modality-tabs button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(modality));
      });
      renderTable();
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      const data = tableData[currentModality] || [];

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem; color: #666;">Keine Daten vorhanden. Bitte zuerst CSV hochladen.</td></tr>';
        return;
      }

      data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = row.row_index;

        // Worker name
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="PPL">${row.PPL}</td>`;

        // Times
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="start_time">${row.start_time}</td>`;
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="end_time">${row.end_time}</td>`;

        // Skills
        ['Normal', 'Notfall', 'Privat', 'Herz', 'Msk', 'Chest'].forEach(skill => {
          const value = row[skill];
          const className = `skill-cell skill-${value}`;
          tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="${skill}" class="${className}">${value}</td>`;
        });

        // Modifier
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="Modifier">${row.Modifier}</td>`;

        // Actions (advanced mode only)
        if (currentMode === 'advanced') {
          tr.innerHTML += `
            <td>
              <div class="action-buttons">
                <button class="btn btn-danger btn-small" onclick="deleteWorkerRow(${row.row_index})">üóëÔ∏è</button>
              </div>
            </td>
          `;
        }

        tbody.appendChild(tr);
      });

      // Add event listeners for contenteditable cells
      document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('blur', handleCellEdit);
      });
    }

    // Handle cell edit
    function handleCellEdit(event) {
      const cell = event.target;
      const row = cell.parentElement;
      const rowIndex = parseInt(row.dataset.rowIndex);
      const col = cell.dataset.col;
      const newValue = cell.textContent.trim();

      // Track change
      if (!pendingChanges[currentModality]) {
        pendingChanges[currentModality] = {};
      }
      if (!pendingChanges[currentModality][rowIndex]) {
        pendingChanges[currentModality][rowIndex] = {};
      }
      pendingChanges[currentModality][rowIndex][col] = newValue;

      // Update local data
      const dataRow = tableData[currentModality].find(r => r.row_index === rowIndex);
      if (dataRow) {
        dataRow[col] = newValue;
      }

      // Visual feedback
      cell.style.background = '#d4edda';
      setTimeout(() => {
        cell.style.background = '';
      }, 500);
    }

    // Save all changes
    async function saveAllChanges() {
      const saveStatus = document.getElementById('save-status');
      saveStatus.textContent = 'üíæ Speichere...';

      let successCount = 0;
      let errorCount = 0;

      for (const modality in pendingChanges) {
        for (const rowIndex in pendingChanges[modality]) {
          const updates = pendingChanges[modality][rowIndex];

          try {
            const response = await fetch('/api/prep-next-day/update-row', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                modality: modality,
                row_index: parseInt(rowIndex),
                updates: updates
              })
            });

            if (response.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            errorCount++;
          }
        }
      }

      // Clear pending changes
      pendingChanges = {};

      if (errorCount === 0) {
        saveStatus.textContent = `‚úÖ ${successCount} √Ñnderungen gespeichert`;
        saveStatus.style.color = '#28a745';
        showMessage('success', `‚úÖ Erfolgreich ${successCount} √Ñnderungen gespeichert`);
      } else {
        saveStatus.textContent = `‚ö†Ô∏è ${successCount} gespeichert, ${errorCount} Fehler`;
        saveStatus.style.color = '#dc3545';
        showMessage('error', `Fehler beim Speichern einiger √Ñnderungen`);
      }

      setTimeout(() => {
        saveStatus.textContent = '';
      }, 3000);
    }

    // Add worker row
    async function addWorkerRow() {
      const workerName = prompt('Worker Name (z.B. "M√ºller (AM)"):', 'Neuer Worker (NW)');
      if (!workerName) return;

      try {
        const response = await fetch('/api/prep-next-day/add-worker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            modality: currentModality,
            worker_data: {
              PPL: workerName,
              start_time: '07:00',
              end_time: '15:00',
              Normal: 1,
              Notfall: 1,
              Privat: 0,
              Herz: 0,
              Msk: 0,
              Chest: 0,
              Modifier: 1.0
            }
          })
        });

        if (response.ok) {
          showMessage('success', `Worker "${workerName}" hinzugef√ºgt`);
          await loadData();
        } else {
          showMessage('error', 'Fehler beim Hinzuf√ºgen');
        }
      } catch (error) {
        showMessage('error', `Fehler: ${error.message}`);
      }
    }

    // Delete worker row
    async function deleteWorkerRow(rowIndex) {
      if (!confirm('Worker wirklich l√∂schen?')) return;

      try {
        const response = await fetch('/api/prep-next-day/delete-worker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            modality: currentModality,
            row_index: rowIndex
          })
        });

        if (response.ok) {
          showMessage('success', 'Worker gel√∂scht');
          await loadData();
        } else {
          showMessage('error', 'Fehler beim L√∂schen');
        }
      } catch (error) {
        showMessage('error', `Fehler: ${error.message}`);
      }
    }

    // Bulk set skill
    function bulkSetSkill() {
      const skill = prompt('Skill Name (Normal, Notfall, Privat, Herz, Msk, Chest):', 'Normal');
      if (!skill) return;

      const value = prompt(`Wert f√ºr ${skill} (-1 = ausgeschlossen, 0 = passiv, 1 = aktiv):`, '1');
      if (value === null) return;

      const parsedValue = parseInt(value);
      if (![- 1, 0, 1].includes(parsedValue)) {
        alert('Ung√ºltiger Wert! Erlaubt: -1, 0, 1');
        return;
      }

      // Update all rows for current modality
      tableData[currentModality].forEach((row, idx) => {
        row[skill] = parsedValue;

        // Track as pending change
        if (!pendingChanges[currentModality]) {
          pendingChanges[currentModality] = {};
        }
        if (!pendingChanges[currentModality][row.row_index]) {
          pendingChanges[currentModality][row.row_index] = {};
        }
        pendingChanges[currentModality][row.row_index][skill] = parsedValue;
      });

      renderTable();
      showMessage('success', `Skill "${skill}" auf ${parsedValue} gesetzt f√ºr alle Workers in ${currentModality.toUpperCase()}`);
    }

    // Show message
    function showMessage(type, message) {
      const container = document.getElementById('message-container');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      container.scrollIntoView({ behavior: 'smooth' });

      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>
